<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"xmlns:th="http://www.thymeleaf.org" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì‚¬ìš©ìí”½ ì½”ìŠ¤ ëª©ë¡</title>
  <link rel="stylesheet" th:href="@{/css/course_list.css}" />
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}"/>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="course-list-container">
  <h1>ì‚¬ìš©ìí”½ ì½”ìŠ¤ ëª©ë¡</h1>
  <div class="filter-section">
    <label for="filterHashtagInput"># í•´ì‹œíƒœê·¸ë¡œ í•„í„°ë§:</label>
    <input type="text" id="filterHashtagInput" placeholder="#ë§›ì§‘ (ì…ë ¥ í›„ Space/Enter)">
    <div id="filterHashtagChipsContainer" class="hashtag-chip-container">
    </div>
  </div>
  <div class="course-list" id="courseList">
  </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
<script th:src="@{/js/header.js}"></script>
<script>
  // â­â­ [ì¶”ê°€] 1. ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ì„ íƒëœ í•„í„°ë§ í•´ì‹œíƒœê·¸ ëª©ë¡ì„ ì €ì¥ â­â­
  let currentFilterHashtags = [];

  // â­â­ [ì¶”ê°€] 2. í—¬í¼ í•¨ìˆ˜: íƒœê·¸ ì´ë¦„ ì •ëˆ (ì¬ì‚¬ìš©) â­â­
  function sanitizeTagName(tag) {
    return tag.replace(/^#+/, '').trim();
  }

  // â­â­ [ì¶”ê°€] 3. í—¬í¼ í•¨ìˆ˜: í•„í„°ë§ í•´ì‹œíƒœê·¸ ì¹© UI ë Œë”ë§ ë° ì´ë²¤íŠ¸ ì—°ê²° â­â­
  function renderFilterHashtagChips() {
    const chipContainer = document.getElementById('filterHashtagChipsContainer');
    if (!chipContainer) return;

    chipContainer.innerHTML = ''; // ê¸°ì¡´ ì¹©ë“¤ì„ ëª¨ë‘ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.

    currentFilterHashtags.forEach(tag => {
      const chip = document.createElement('span');
      chip.className = 'hashtag-chip';
      chip.innerHTML = `#${tag} <button class="remove-hashtag-btn" data-tag="${tag}">x</button>`;
      chipContainer.appendChild(chip);
    });

    chipContainer.querySelectorAll('.remove-hashtag-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const tagToRemove = event.target.dataset.tag;
        currentFilterHashtags = currentFilterHashtags.filter(tag => tag !== tagToRemove);
        renderFilterHashtagChips(); // UI ì—…ë°ì´íŠ¸
        fetchAndRenderCourses(); // â­ í•´ì‹œíƒœê·¸ ì œê±° ì‹œ ì½”ìŠ¤ ëª©ë¡ ì¬ì¡°íšŒ â­
      });
    });
  }
  let currentPage = 1; // â­ í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ì €ì¥

  // 1. ì½”ìŠ¤ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë Œë”ë§í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
  function fetchAndRenderCourses(page = 1) {
    currentPage = page; // í˜ì´ì§€ ì—…ë°ì´íŠ¸
    const courseList = document.getElementById('courseList');
    courseList.innerHTML = '<p style="text-align: center; color: #888;">ì½”ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';

    let fetchUrl = `/api/recommend-courses?page=${page}`;

    if (currentFilterHashtags.length > 0) {
      // ì´ë¯¸ URLì— ?ê°€ ìˆìœ¼ë‹ˆ &ë¡œ ì´ì–´ë¶™ì…ë‹ˆë‹¤.
      fetchUrl += `&hashtags=${currentFilterHashtags.join(',')}`;
    }

    fetch(fetchUrl)
    .then(response => {
      if (!response.ok) throw new Error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤");
      return response.json();
    })
    .then(apiResponse => {
      // ì„œë²„ ì‘ë‹µ êµ¬ì¡°ê°€ ApiResponse<Page<CourseDto>> ì¼ ë•Œë¥¼ ê°€ì •
      // ë§Œì•½ data ìì²´ê°€ ë¦¬ìŠ¤íŠ¸ë¼ë©´ apiResponse.data.content ë“±ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
      const courses = apiResponse.data.content || apiResponse.data || [];
      const totalPages = apiResponse.data.totalPages || 1; // ì „ì²´ í˜ì´ì§€ ìˆ˜

      renderCourseCards(courses);    // ì¹´ë“œ ê·¸ë¦¬ê¸°
      renderPaginationUI(totalPages); // í˜ì´ì§€ ë²„íŠ¼ ê·¸ë¦¬ê¸°
    })
    .catch(error => {
      console.error('ì—ëŸ¬ ë°œìƒ:', error);
      courseList.innerHTML = '<p style="text-align: center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    });
  }

  // 2. ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  function renderCourseCards(courses) {
    const courseList = document.getElementById('courseList');
    courseList.innerHTML = '';

    if (courses.length === 0) {
      courseList.innerHTML = '<p style="text-align: center; color: #888;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    courses.forEach(course => {
      const card = document.createElement('div');
      card.className = 'course-card';
      card.onclick = () => window.location.href = `/recommend-courses/${course.courseId}`;

      const imageUrl = (course.imageUrl && course.imageUrl.length > 0) ? course.imageUrl : "/image/bg_night.jpg";
      const hashtagsHtml = (course.hashtagNames && course.hashtagNames.length > 0)
          ? `<div class="course-tags">${course.hashtagNames.map(tag => `<span>#${tag}</span>`).join('')}</div>` : '';

      card.innerHTML = `
      <img src="${imageUrl}" alt="${course.title} ì¸ë„¤ì¼" />
      <div class="course-card-content">
        <div class="course-title">${course.title}</div>
        ${hashtagsHtml}
        <div class="card-author">
          <div class="author-avatar" style="background-image:url('/images/user.jpg');"></div>
          <div class="course-instructor">${course.creatorNickname}</div>
        </div>
        <div class="card-footer">
          <div class="card-stats">â¤ï¸ ${course.favoriteCnt}</div>
          <div class="card-stats">ğŸ’¬ ${course.reviewCnt}</div>
        </div>
      </div>
    `;
      courseList.appendChild(card);
    });
  }

  function renderPaginationUI(totalPages) {
    let paginationContainer = document.getElementById('pagination');
    if (!paginationContainer) {
      paginationContainer = document.createElement('div');
      paginationContainer.id = 'pagination';
      paginationContainer.className = 'pagination-container';
      document.querySelector('.course-list-container').appendChild(paginationContainer);
    }

    paginationContainer.innerHTML = '';

    // í‘œì‹œí•  í˜ì´ì§€ ë²„íŠ¼ì˜ ë²”ìœ„ ì„¤ì • (ì˜ˆ: í˜„ì¬ í˜ì´ì§€ ì•ë’¤ë¡œ 2ê°œì”©, ì´ 5ê°œ)
    const pageLimit = 5;
    let startPage = Math.max(1, currentPage - Math.floor(pageLimit / 2));
    let endPage = Math.min(totalPages, startPage + pageLimit - 1);

    // ëë¶€ë¶„ì—ì„œ ë²”ìœ„ê°€ ëª¨ìë„ ê²½ìš° ì‹œì‘ í˜ì´ì§€ ì¬ì¡°ì •
    if (endPage - startPage + 1 < pageLimit) {
      startPage = Math.max(1, endPage - pageLimit + 1);
    }

    // [ì²˜ìŒìœ¼ë¡œ] ë²„íŠ¼
    if (startPage > 1) {
      appendPageBtn(paginationContainer, 1, '<<');
    }

    // [ì´ì „] ë²„íŠ¼
    if (currentPage > 1) {
      const prevBtn = document.createElement('button');
      prevBtn.innerText = '<';
      prevBtn.onclick = () => fetchAndRenderCourses(currentPage - 1);
      paginationContainer.appendChild(prevBtn);
    }

    // ìˆ«ì í˜ì´ì§€ ë²„íŠ¼
    for (let i = startPage; i <= endPage; i++) {
      appendPageBtn(paginationContainer, i, i);
    }

    // [ë‹¤ìŒ] ë²„íŠ¼
    if (currentPage < totalPages) {
      const nextBtn = document.createElement('button');
      nextBtn.innerText = '>';
      nextBtn.onclick = () => fetchAndRenderCourses(currentPage + 1);
      paginationContainer.appendChild(nextBtn);
    }

    // [ë§ˆì§€ë§‰ìœ¼ë¡œ] ë²„íŠ¼
    if (endPage < totalPages) {
      appendPageBtn(paginationContainer, totalPages, '>>');
    }
  }

  // ë²„íŠ¼ ìƒì„±ì„ ë•ëŠ” í—¬í¼ í•¨ìˆ˜
  function appendPageBtn(container, pageNum, text) {
    const btn = document.createElement('button');
    btn.innerText = text;
    btn.className = (pageNum === currentPage) ? 'page-btn active' : 'page-btn';
    btn.onclick = () => fetchAndRenderCourses(pageNum);
    container.appendChild(btn);
  }
  // â­ [í•„ìˆ˜ ì¶”ê°€] í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹¤í–‰ ë° ì´ë²¤íŠ¸ ì—°ê²° ë¡œì§
  document.addEventListener('DOMContentLoaded', () => {
    fetchAndRenderCourses(1); // í˜ì´ì§€ ì—´ë¦¬ìë§ˆì 1í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ê¸°

    const filterHashtagInput = document.getElementById('filterHashtagInput');
    if (filterHashtagInput) {
      filterHashtagInput.addEventListener('keyup', (event) => {
        if (event.key === ' ' || event.key === 'Enter') {
          event.preventDefault();
          let inputValue = filterHashtagInput.value.trim();
          const newTag = sanitizeTagName(inputValue);

          if (newTag.length > 0 && !currentFilterHashtags.includes(newTag)) {
            currentFilterHashtags.push(newTag);
            filterHashtagInput.value = '';
            renderFilterHashtagChips();
            fetchAndRenderCourses(1); // â­ íƒœê·¸ ì¶”ê°€ ì‹œ 1í˜ì´ì§€ë¶€í„° ë‹¤ì‹œ ì¡°íšŒ
          }
        }
      });
    }
  });
</script>
