<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"xmlns:th="http://www.thymeleaf.org" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì‚¬ìš©ìí”½ ì½”ìŠ¤ ëª©ë¡</title>
  <link rel="stylesheet" th:href="@{/css/course_list.css}" />
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}"/>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="course-list-container">
  <h1>ì‚¬ìš©ìí”½ ì½”ìŠ¤ ëª©ë¡</h1>
  <div class="filter-section">
    <label for="filterHashtagInput"># í•´ì‹œíƒœê·¸ë¡œ í•„í„°ë§:</label>
    <input type="text" id="filterHashtagInput" placeholder="#ë§›ì§‘ (ì…ë ¥ í›„ Space/Enter)">
    <div id="filterHashtagChipsContainer" class="hashtag-chip-container">
    </div>
  </div>
  <div class="course-list" id="courseList">
  </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
<script th:src="@{/js/header.js}"></script>
<script>
  // â­â­ [ì¶”ê°€] 1. ì „ì—­ ë³€ìˆ˜: í˜„ì¬ ì„ íƒëœ í•„í„°ë§ í•´ì‹œíƒœê·¸ ëª©ë¡ì„ ì €ì¥ â­â­
  let currentFilterHashtags = [];

  // â­â­ [ì¶”ê°€] 2. í—¬í¼ í•¨ìˆ˜: íƒœê·¸ ì´ë¦„ ì •ëˆ (ì¬ì‚¬ìš©) â­â­
  function sanitizeTagName(tag) {
    return tag.replace(/^#+/, '').trim();
  }

  // â­â­ [ì¶”ê°€] 3. í—¬í¼ í•¨ìˆ˜: í•„í„°ë§ í•´ì‹œíƒœê·¸ ì¹© UI ë Œë”ë§ ë° ì´ë²¤íŠ¸ ì—°ê²° â­â­
  function renderFilterHashtagChips() {
    const chipContainer = document.getElementById('filterHashtagChipsContainer');
    if (!chipContainer) return;

    chipContainer.innerHTML = ''; // ê¸°ì¡´ ì¹©ë“¤ì„ ëª¨ë‘ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.

    currentFilterHashtags.forEach(tag => {
      const chip = document.createElement('span');
      chip.className = 'hashtag-chip';
      chip.innerHTML = `#${tag} <button class="remove-hashtag-btn" data-tag="${tag}">x</button>`;
      chipContainer.appendChild(chip);
    });

    chipContainer.querySelectorAll('.remove-hashtag-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const tagToRemove = event.target.dataset.tag;
        currentFilterHashtags = currentFilterHashtags.filter(tag => tag !== tagToRemove);
        renderFilterHashtagChips(); // UI ì—…ë°ì´íŠ¸
        fetchAndRenderCourses(); // â­ í•´ì‹œíƒœê·¸ ì œê±° ì‹œ ì½”ìŠ¤ ëª©ë¡ ì¬ì¡°íšŒ â­
      });
    });
  }

  // â­â­ [ì¶”ê°€] 4. ì½”ìŠ¤ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë Œë”ë§í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ â­â­
  // í•´ì‹œíƒœê·¸ í•„í„°ë¥¼ ì ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
  function fetchAndRenderCourses() {
    const courseList = document.getElementById('courseList');
    courseList.innerHTML = '<p style="text-align: center; color: #888;">ì½”ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>'; // ë¡œë”© ë©”ì‹œì§€

    // í•„í„°ë§ í•´ì‹œíƒœê·¸ë¥¼ URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜ (ì˜ˆ: ?hashtags=ë§›ì§‘,ì¹´í˜)
    const queryParams = new URLSearchParams();
    if (currentFilterHashtags.length > 0) {
      queryParams.append('hashtags', currentFilterHashtags.join(','));
    }
    const queryString = queryParams.toString();
    const fetchUrl = queryString ? `/api/recommend-courses?${queryString}` : '/api/recommend-courses';

    fetch(fetchUrl)
    .then(response => {
      if (!response.ok) {
        if (response.status === 404) { // 404 Not FoundëŠ” ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒìœ¼ë¡œ ê°„ì£¼
          return response.json().then(errorData => {
            if (errorData.message === "No courses found for the given hashtags") {
              return []; // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒìœ¼ë¡œ ì²˜ë¦¬
            } else {
              throw new Error(errorData.message || "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
          });
        }
        throw new Error("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤");
      }
      return response.json();
    })
    .then(apiResponse => { // â­ ì„œë²„ ì‘ë‹µì´ ApiResponse<List<CourseListItemDto>> í˜•íƒœë¼ê³  ê°€ì •
      const courses = apiResponse.data || []; // apiResponse.dataì—ì„œ ì‹¤ì œ ì½”ìŠ¤ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ

      courseList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

      if (courses.length === 0) {
        courseList.innerHTML = '<p style="text-align: center; color: #888;">í•´ë‹¹ í•´ì‹œíƒœê·¸ë¥¼ í¬í•¨í•˜ëŠ” ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      courses.forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        card.onclick = () => {
          window.location.href = `/recommend-courses/${course.courseId}`;
        };

        // â­â­ [ìˆ˜ì •] 7. ì´ë¯¸ì§€ URLì€ ë°±ì—”ë“œì—ì„œ ì´ë¯¸ /images/ ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ ë³´ë‚´ë¯€ë¡œ ì§ì ‘ ì‚¬ìš© â­â­
        const imageUrl = course.imageUrl && course.imageUrl.length > 0
            ? course.imageUrl
            : "/image/bg_night.jpg"; // ê¸°ë³¸ ì´ë¯¸ì§€

        // â­â­ [ì¶”ê°€] 6. í•´ì‹œíƒœê·¸ ë Œë”ë§ ë¡œì§ ì¶”ê°€ â­â­
        const hashtagsHtml = course.hashtagNames && course.hashtagNames.length > 0
            ? `<div class="course-tags">${course.hashtagNames.map(tag => `<span>#${tag}</span>`).join('')}</div>`
            : '';


        card.innerHTML = `
          <img src="${imageUrl}" alt="${course.title} ì¸ë„¤ì¼" />
          <div class="course-card-content">
            <div class="course-title">${course.title}</div>
            ${hashtagsHtml} <div class="card-author">
              <div class="author-avatar" style="background-image:url('/images/user.jpg');"></div>
            <div class="course-instructor">${course.creatorNickname}</div>
            </div>
            <div class="card-footer">
            <div class ="card-stats">â¤ï¸ ${course.favoriteCnt}</div>
            <div class ="card-stats">ğŸ’¬ ${course.reviewCnt}</div>
          </div>
          </div>
        `;
        courseList.appendChild(card);
      });
    })
    .catch(error => {
      console.error('ì—ëŸ¬ ë°œìƒ:', error);
      courseList.innerHTML = '<p>ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    });
  }

  // â­â­ [ìˆ˜ì •] 7. DOMContentLoaded ì´ë²¤íŠ¸ì—ì„œ ì´ˆê¸° ë¡œë”© í•¨ìˆ˜ í˜¸ì¶œ ë° í•„í„°ë§ ì´ë²¤íŠ¸ ì„¤ì • â­â­
  document.addEventListener('DOMContentLoaded', () => {
    fetchAndRenderCourses(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì½”ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°

    const filterHashtagInput = document.getElementById('filterHashtagInput');
    if (filterHashtagInput) {
      filterHashtagInput.addEventListener('keyup', (event) => {
        if (event.key === ' ' || event.key === 'Enter') {
          event.preventDefault();

          let inputValue = filterHashtagInput.value.trim();
          if (event.key === ' ' && inputValue.endsWith(' ')) {
            inputValue = inputValue.substring(0, inputValue.length - 1).trim();
          }

          const newTag = sanitizeTagName(inputValue);

          if (newTag.length > 0) {
            if (!currentFilterHashtags.includes(newTag)) {
              currentFilterHashtags.push(newTag);
              filterHashtagInput.value = '';
              renderFilterHashtagChips();
              fetchAndRenderCourses(); // â­ í•´ì‹œíƒœê·¸ ì¶”ê°€ ì‹œ ì½”ìŠ¤ ëª©ë¡ ì¬ì¡°íšŒ â­
            } else {
              alert(`'${newTag}' í•´ì‹œíƒœê·¸ëŠ” ì´ë¯¸ í•„í„°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              filterHashtagInput.value = '';
            }
          } else if (inputValue.length > 0) {
            filterHashtagInput.value = '';
          }
        }
      });

      filterHashtagInput.addEventListener('blur', () => {
        const inputValue = filterHashtagInput.value.trim();
        const newTag = sanitizeTagName(inputValue);
        if (newTag.length > 0 && !currentFilterHashtags.includes(newTag)) {
          currentFilterHashtags.push(newTag);
          filterHashtagInput.value = '';
          renderFilterHashtagChips();
          fetchAndRenderCourses(); // â­ í•´ì‹œíƒœê·¸ ì¶”ê°€ ì‹œ ì½”ìŠ¤ ëª©ë¡ ì¬ì¡°íšŒ â­
        }
      });
    }
  });
</script>
