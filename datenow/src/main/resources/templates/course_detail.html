
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì‚¬ìš©ì ì½”ìŠ¤ ìƒì„¸í˜ì´ì§€</title>
  <link rel="stylesheet" th:href="@{/css/editor_pick_detail.css}" />
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/review.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}"/>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="course-detail-container">
  <div class="course-header">
    <img id="thumbnail" src="" alt="ì½”ìŠ¤ ì¸ë„¤ì¼" class="course-thumbnail" />
  </div>
  <div class="course-info">
    <div class="title-button">
      <h1 id="courseTitle" class="course-title"></h1>
      <button
          th:attr="data-recommend-id=${recommendId}"
          th:classappend="${isLiked} ? ' liked' : ' unliked'"
          class="like-button"
          onclick="toggleLike(this)">
        <span th:text="${isLiked} ? 'â¤ï¸' : 'ğŸ©¶'"></span>
      </button>
    </div>

    <p id="courseInstructor" class="course-instructor"></p>
    <p id="courseDate" class="course-date"></p>
    <div id="imageGallery" class="image-gallery"></div>
    <div class="course-description">
      <p id="courseDescription" class="course-description-text"></p>
    </div>
    <div id="placeList" class="place-list"></div>
  </div>

</div>

<div class="review-form">
  <h3>ë¦¬ë·° ì‘ì„±</h3>
  <textarea id="reviewContent" placeholder="ë¦¬ë·°ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
  <br />
  <label>ë³„ì :
    <select id="reviewStar">
      <option value="1">1ì </option>
      <option value="2">2ì </option>
      <option value="3">3ì </option>
      <option value="4">4ì </option>
      <option value="5" selected>5ì </option>
    </select>
  </label>
  <br />
  <button onclick="submitReview()">ë¦¬ë·° ë“±ë¡</button>
</div>
<div class="review-list-container">
  <h3>ë¦¬ë·° ëª©ë¡</h3>
  <div id="reviewList" class="review-list"></div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script>
  const recommendId = [[${recommendId}]];
  const currentUserNickname = '[[${loginNickname}]]';

  fetch(`/api/recommend-courses/${recommendId}`)
  .then(res => res.json())
  .then(data => {
    const imageUrl = data.imageUrl && data.imageUrl.length > 0
        ? data.imageUrl[0]
        : "/image/bg_night.jpg";
    document.getElementById("thumbnail").src = imageUrl;

    document.getElementById("courseTitle").innerText = data.title;
    document.getElementById("courseInstructor").innerText = `ì‘ì„±ì: ${data.nickname}`;
    document.getElementById("courseDate").innerText = `ë“±ë¡ì¼: ${data.createdAt.split("T")[0]}`;
    document.getElementById("courseDescription").innerText = data.description;
    const imageGallery = document.getElementById("imageGallery");
    imageGallery.innerHTML = ""; // ì´ˆê¸°í™”

    if (data.imageUrl && data.imageUrl.length > 0) {
      data.imageUrl.forEach(url => {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "ì¥ì†Œ ì´ë¯¸ì§€";
        img.className = "gallery-image";

        imageGallery.appendChild(img);
      });
    }

    const placeList = document.getElementById("placeList");
    placeList.innerHTML = "";
    data.places.forEach(place => {
      const div = document.createElement("div");
      div.className = "place-card";
      div.innerHTML = `
    <h3>${place.title}</h3>
    <p>${place.address}</p>
  `;
      placeList.appendChild(div);
    });

  })
  .catch(err => {
    console.error("ì½”ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", err);
  });



  function toggleLike(button) {
    const recommendId = button.dataset.recommendId;

    fetch(`/api/users/${recommendId}/likes`, {
      method: 'POST',
      credentials: "include",
    })
    .then(response => {
      if (response.ok) {
        const span = button.querySelector('span');
        const isLiked = span.textContent === 'â¤ï¸';
        span.textContent = isLiked ? 'ğŸ©¶' : 'â¤ï¸';
        button.classList.toggle('liked');
        button.classList.toggle('unliked');
      } else {
        alert("ì°œ ì‹¤íŒ¨!");
      }
    });
  }



  function submitReview() {
    const content = document.getElementById("reviewContent").value;
    const star = parseInt(document.getElementById("reviewStar").value);

    if (!content) {
      alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    fetch(`/api/recommend-courses/${recommendId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      credentials: "include",
      body: JSON.stringify({
        content: content,
        star: star
      })
    })
    .then(res => {
      if (!res.ok) throw new Error("ì‘ë‹µ ì˜¤ë¥˜");
      return res.json();
    })
    .then(data => {
      alert("ë¦¬ë·° ë“±ë¡ ì„±ê³µ!");
      location.reload();
    })
    .catch(err => {
      console.error("ë¦¬ë·° ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", err);
      alert("ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨");
    });

  }

  function loadReviews() {
    fetch(`/api/recommend-courses/${recommendId}/reviews`)
    .then(res => res.json())
    .then(data => {
      const reviewList = document.getElementById("reviewList");
      reviewList.innerHTML = "";

      if (!data.length) {
        reviewList.innerHTML = "<p>ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      data.forEach(review => {
        const div = document.createElement("div");
        div.className = "review-item";
        const isMyReview = review.nickname === currentUserNickname;
        div.innerHTML = `
            <div class="review-header">
              <span class="review-nickname">${review.nickname}</span>
              <span class="review-date">${review.createdAt.split("T")[0]}</span>
            </div>
            <div class="review-star">${'â­'.repeat(review.star)} (${review.star}ì )</div>
            <div class="review-content">${review.content}</div>
            ${isMyReview ? `<button class="review-delete-button" onclick="deleteReview(${review.reviewId})">ì‚­ì œ</button>` : ""}
          `;
        reviewList.appendChild(div);
      });
    })
    .catch(err => {
      console.error("ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
    });
  }


  document.addEventListener("DOMContentLoaded", () => {
    loadReviews();
  });
  function deleteReview(reviewId) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch(`/api/recommend-courses/delete/${reviewId}`, {
      method: "POST",
      credentials: "include"
    })
    .then(res => {
      if (res.ok) {
        alert("ì‚­ì œ ì™„ë£Œ");
        loadReviews();
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨");
      }
    })
    .catch(err => {
      console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ", err);
      alert("ì—ëŸ¬ ë°œìƒ");
    });
  }


</script>
</body>
</html>


