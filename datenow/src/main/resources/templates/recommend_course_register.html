<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DateNow - ì¶”ì²œ ì½”ìŠ¤ ë“±ë¡</title>
  <link rel="stylesheet" th:href="@{/css/recommend_course_register.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}"/>
  <link rel="stylesheet" th:href="@{/css/header.css}"/>
  <link rel="stylesheet" th:href="@{/css/mypage.css}"/>
  <link rel="stylesheet" th:href="@{/css/sidebar.css}"/>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="container">
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>
  <main class="main-content">
    <!-- ì¶”ì²œì½”ìŠ¤ ë“±ë¡ ì˜ì—­ -->
    <section id="register-section" style="display: block;">
      <header class="header">
        <h1 class="title">ì¶”ì²œ ì½”ìŠ¤ë¡œ ë“±ë¡í•˜ê¸°</h1>
      </header>
      <main class="main">
        <section class="course-section">
          <h2 class="section-title section-subtitle">ì½”ìŠ¤ ì œëª© ë¡œë”© ì¤‘...</h2>
          <div id="place-list" class="place-grid">
            <!-- JSê°€ ì¥ì†Œ ì¹´ë“œ ë Œë”ë§ -->
          </div>
        </section>

        <section class="image-upload-section">
          <h3 class="upload-info">ë°ì´íŠ¸ ì½”ìŠ¤ë¥¼ ì†Œê°œí•˜ëŠ” ì‚¬ì§„ì„ ë„£ì–´ì£¼ì„¸ìš”! (ìµœì†Œ 1ì¥, ìµœëŒ€ 10ì¥)</h3>
          <p class="upload-format">* jpeg / png íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

          <input type="file" id="courseImages" accept="image/jpeg, image/png" multiple style="display: none;">
          <div class="image-grid">
            <div class="image-upload-box" id="uploadBox">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                   xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
          </div>
          <div id="imagePreviewContainer" class="image-preview-container"></div>
        </section>

        <div class="button-container">
          <button class="button button-cancel">ì·¨ì†Œ</button>
          <button class="button button-submit">ë“±ë¡í•˜ê¸°</button>
        </div>
        <input type="hidden" id="courseId" th:value="${courseId}">
      </main>
    </section>
  </main>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script th:src="@{/js/sidebar.js}"></script>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('courseImages');
    const previewContainer = document.getElementById('imagePreviewContainer');
    const uploadBox = document.getElementById('uploadBox');
    const submitButton = document.querySelector('.button-submit');
    const cancelButton = document.querySelector('.button-cancel');
    const maxImages = 10;
    // currentImagesëŠ” íŒŒì¼ ê°ì²´ ìì²´ë¥¼ ê´€ë¦¬í•˜ê³ , uploadedImageUrlsëŠ” ì„œë²„ì—ì„œ ë°›ì€ URL ë¬¸ìì—´ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
    let currentImages = []; // ì—…ë¡œë“œí•  íŒŒì¼ ê°ì²´ ë¦¬ìŠ¤íŠ¸
    let uploadedImageUrls = []; // ì„œë²„ì—ì„œ ë°˜í™˜ë°›ì€ URL ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸
    let isProcessing = false;
    const courseId = document.getElementById('courseId').value;

    // ì½”ìŠ¤ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch(`/api/course/my-course/${courseId}`, {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      credentials: 'include'
    })
    .then(response => response.json())
    .then(apiResponse => {
      if (apiResponse.code === "0000") {
        const course = apiResponse.data;

        const sectionSubtitle = document.querySelector('.section-subtitle');
        if (sectionSubtitle && course.title) {
          sectionSubtitle.textContent = course.title;
        }

        const placeContainer = document.getElementById('place-list');
        if (placeContainer && course.places && course.places.length > 0) {
          placeContainer.innerHTML = '';
          course.places.forEach(place => {
            const card = document.createElement('div');
            card.className = 'place-card';
            card.innerHTML = `
                    <div class="place-image-container">
                        <input type="file" class="place-image-input" accept="image/*" hidden>
                        <div class="place-image-placeholder">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>${place.title}</span>
                        </div>
                        <p class="place-address">${place.address}</p>
                    </div>`;
            placeContainer.appendChild(card);
          });
        }
      } else {
        alert('ì½”ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (apiResponse.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        console.error('API Error:', apiResponse);
      }
    })
    .catch(error => {
      console.error('Fetch Error:', error);
      alert('ì½”ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    });

    uploadBox.addEventListener('click', () => { if (!isProcessing) imageInput.click(); });
    imageInput.addEventListener('click', e => e.stopPropagation());
    imageInput.addEventListener('change', async function(e) {
      if (isProcessing) return;
      isProcessing = true;

      const files = Array.from(e.target.files);
      if (currentImages.length + files.length > maxImages) {
        alert(`ì´ë¯¸ì§€ëŠ” ìµœëŒ€ ${maxImages}ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        isProcessing = false;
        return;
      }

      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ 10MB ì œí•œì„ ì„¤ì •í•´ë„ ì„œë²„ ì¸¡ì—ì„œë„ í•„ìˆ˜ë¡œ ê²€ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤.
      const oversizedFiles = files.filter(file => file.size > 10 * 1024 * 1024);
      if (oversizedFiles.length > 0) {
        alert('ê° ì´ë¯¸ì§€ì˜ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        isProcessing = false;
        return;
      }

      try {
        const formData = new FormData();
        files.forEach(file => formData.append('images', file));

        const response = await fetch('/api/course/images', {
          method: 'POST',
          body: formData,
          headers: { 'Accept': 'application/json' }
        });

        // ğŸ”´ ì‘ë‹µ ê°ì²´ ì „ì²´ë¥¼ ë¨¼ì € ë°›ì•„ì˜µë‹ˆë‹¤.
        const apiResponse = await response.json();

        if (!response.ok) {
          // ì„œë²„ì—ì„œ ApiResponse.fail í˜•ì‹ìœ¼ë¡œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•  ë•Œ
          throw new Error(apiResponse.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        // ğŸ”´ apiResponse.dataì— ì‹¤ì œ URL ë°°ì—´ì´ ìˆìŠµë‹ˆë‹¤.
        const newUploadedUrls = apiResponse.data;

        // currentImages ë°°ì—´ê³¼ newUploadedUrls ë°°ì—´ì˜ ê¸¸ì´ë¥¼ ë§ì¶° ê´€ë¦¬í•©ë‹ˆë‹¤.
        // ê° íŒŒì¼ì— í•´ë‹¹í•˜ëŠ” URLì„ ë§¤í•‘í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const uploadedUrl = newUploadedUrls[i]; // í•´ë‹¹ íŒŒì¼ì˜ URL

          const reader = new FileReader();
          reader.onload = e => {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            previewDiv.dataset.uploadedUrl = uploadedUrl; // URLì„ data ì†ì„±ì— ì €ì¥

            const img = document.createElement('img');
            img.src = e.target.result; // ë¯¸ë¦¬ë³´ê¸°ìš© base64 URL
            img.className = 'preview-image';

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Ã—';
            deleteBtn.className = 'remove-image';
            deleteBtn.onclick = ev => {
              ev.stopPropagation();
              previewDiv.remove(); // DOMì—ì„œ ë¯¸ë¦¬ë³´ê¸° ì œê±°

              // currentImages ë°°ì—´ì—ì„œ íŒŒì¼ ì œê±°
              const fileIndex = currentImages.indexOf(file);
              if (fileIndex > -1) {
                currentImages.splice(fileIndex, 1);
              }

              // uploadedImageUrls ë°°ì—´ì—ì„œ í•´ë‹¹ URL ì œê±°
              const urlToRemove = previewDiv.dataset.uploadedUrl;
              const urlIndex = uploadedImageUrls.indexOf(urlToRemove);
              if (urlIndex > -1) {
                uploadedImageUrls.splice(urlIndex, 1);
              }
            };

            previewDiv.appendChild(img);
            previewDiv.appendChild(deleteBtn);
            previewContainer.appendChild(previewDiv);

            currentImages.push(file); // íŒŒì¼ ê°ì²´ëŠ” currentImagesì—
            uploadedImageUrls.push(uploadedUrl); // ì—…ë¡œë“œëœ URLì€ uploadedImageUrlsì—
          };
          reader.readAsDataURL(file);
        }

      } catch (err) {
        console.error('Error:', err);
        alert(err.message);
      } finally {
        isProcessing = false;
        imageInput.value = ''; // ë™ì¼ íŒŒì¼ ì¬ì„ íƒ ì‹œ change ì´ë²¤íŠ¸ ë°œìƒì‹œí‚¤ê¸° ìœ„í•¨
      }
    });

    submitButton.addEventListener('click', async function() {
      if (isProcessing) return;
      isProcessing = true;

      try {
        if (uploadedImageUrls.length === 0) {
          alert('ìµœì†Œ 1ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
          isProcessing = false;
          return;
        }

        // ğŸ”´ ì—¬ê¸°ëŠ” ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ì „ë‹¬ë˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.
        const response = await fetch('/api/course/recommend-course-register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageUrls: uploadedImageUrls, courseId }) // imageUrlsëŠ” ì´ë¯¸ ìˆœìˆ˜ URL ë¬¸ìì—´ ë°°ì—´
        });

        const apiResult = await response.json(); // ì‘ë‹µ ê°ì²´ ì „ì²´ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.

        if (response.ok) {
          alert('ì½”ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = '/recommend-courses';
        } else {
          // ì„œë²„ì—ì„œ ApiResponse.fail í˜•ì‹ìœ¼ë¡œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•  ë•Œ
          throw new Error(apiResult.message || 'ì½”ìŠ¤ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('Error:', err);
        alert(err.message);
      } finally {
        isProcessing = false;
      }
    });

    cancelButton.addEventListener('click', () => window.history.back());
  });
</script>
</body>
</html>